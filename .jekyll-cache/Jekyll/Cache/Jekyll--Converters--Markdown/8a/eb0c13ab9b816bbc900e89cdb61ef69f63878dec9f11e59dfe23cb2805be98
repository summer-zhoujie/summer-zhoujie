I"²Ş<h1 id="ä¸€ä½œç”¨">ä¸€ã€ä½œç”¨</h1>
<p><img src="https://img-blog.csdnimg.cn/20210317194500875.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1Nzc4MzY5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<ol>
  <li>Android ä¸­å›¾ç‰‡æ˜¾ç¤ºçš„å®ä½“å…¶å®æ˜¯ä¸€ä¸ª Bitmap å¯¹è±¡, æ¯æ¬¡å›¾ç‰‡æ˜¾ç¤ºæ—¶, éƒ½ä¼šæ„å»ºä¸€ä¸ª Bitmap å¯¹è±¡, ä¸ç”¨æ—¶å†é”€æ¯</li>
  <li>å‡è®¾: ä¸€ä¸ªé•¿åˆ—è¡¨æ¯é¡¹éƒ½æœ‰ä¸ªå›¾ç‰‡éœ€è¦æ˜¾ç¤º, æˆ‘ä»¬åœ¨å¿«é€Ÿæ»‘åŠ¨é•¿åˆ—è¡¨çš„æ—¶å€™, ä¼šäº§ç”Ÿä»€ä¹ˆ?
  	Bitmap å¯¹è±¡è¢«é¢‘ç¹çš„åˆ›å»ºå’Œé‡Šæ”¾, å¯¼è‡´ GC é¢‘ç¹</li>
  <li>å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜?
 BitmapPool , ä¸€ä¸ª Bitmap çš„å¯¹è±¡æ± , è®©ä¸€ä¸ªæ–°çš„å›¾ç‰‡èµ„æºå¤ç”¨åœ¨æ—§çš„ Bitmapå¯¹è±¡ä¸Š, å‡è®¾, é•¿åˆ—è¡¨ä¸€é¡µæœ‰ 20 ä¸ªå›¾ç‰‡èµ„æº, BitmapPool å¤§å°ä¹Ÿåˆšå¥½æ˜¯ 20 , é‚£ä¹ˆå½“æ»‘åŠ¨åˆ—è¡¨çš„æ—¶å€™, æˆ‘ä»¬ä¸€ç›´åœ¨æ²¿ç”¨æœ€å¼€å§‹åˆ›å»ºçš„ 20 ä¸ª Bitmap å¯¹è±¡, ä¹Ÿå°±è§£å†³äº†é¢‘ç¹ GC çš„é—®é¢˜(é¢‘ç¹çš„ GC ä¼šå¯¼è‡´å¡é¡¿)</li>
</ol>

<h1 id="äºŒåŸç†">äºŒã€åŸç†</h1>
<p><img src="https://img-blog.csdnimg.cn/20210317200040202.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1Nzc4MzY5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>

<h2 id="æ¡†æ¶ç»“æ„">æ¡†æ¶ç»“æ„</h2>
<p>å¦‚ä¸Šå›¾:</p>
<ol>
  <li>BitmapPool ä¸€å…±æœ‰ä¸¤ç§å®ç° <strong>BitmapPoolAdapter</strong> å’Œ <strong>LruBitmapPool</strong></li>
  <li>å…¶ä¸­, <strong>BitmapPoolAdapter</strong> æ˜¯<strong>ç©ºå®ç°</strong></li>
  <li><strong>LruBitmapPool</strong> å­—é¢æ„æ€å¯çŒœ: <strong>ä¸€ä¸ª LRU ç®—æ³•å®ç°çš„ Bitmap ç¼“å­˜æ± </strong></li>
  <li>LruBitmapPool çš„ <strong>LRU ç®—æ³•</strong>å®ç°ä¾èµ–äº <strong>LruPoolStrategy æä¾›åŠŸèƒ½æ”¯æŒ</strong></li>
  <li>åˆ , LruPoolStrategy æœ‰ä¸‰ç§å®ç°æ–¹æ¡ˆ <strong>AttributeStrategy</strong> , <strong>SizeConfigStrategy</strong> å’Œ <strong>SizeStrategy</strong></li>
</ol>

<h2 id="æ¥å£æŠ½è±¡">æ¥å£æŠ½è±¡</h2>
<p>å…ˆæ¥çœ‹çœ‹ BitmapPool æ¥å£æ˜¯å¦‚ä½•æŠ½è±¡çš„</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * å®šä¹‰äº†ä¸€ä¸ªå…è®¸å¤ç”¨ Bitmap å¯¹è±¡çš„æ± å­çš„æ¥å£
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BitmapPool</span> <span class="o">{</span>

    <span class="cm">/**
     * è¿”å›å½“å‰ BitmapPool çš„æœ€å¤§å®¹é‡ï¼Œå•ä½æ˜¯ byte å­—èŠ‚
     */</span>
    <span class="kt">int</span> <span class="nf">getMaxSize</span><span class="o">();</span>

    <span class="cm">/**
     * å¯ä»¥é€šè¿‡æ­¤æ–¹æ³•è®¾ç½®ä¸€ä¸ªå› å­ï¼Œæ­¤å› å­ä¼šä¹˜ä»¥æœ€å¼€å§‹è®¾ç½®çš„æœ€å¤§å®¹é‡ï¼Œå°†ç»“æœä½œä¸ºæ–°çš„æœ€å¤§å®¹é‡
     *
     * Note1: ä¸Šé¢è®¡ç®—å®Œæˆä»¥åï¼Œå¦‚æœ BitmapPool çš„å½“å‰å®é™…å®¹é‡æ¯”å½“å‰æœ€å¤§å®¹é‡å¤§ï¼Œåˆ™ä¼šæ¸…é™¤ BitampPool ä¸­çš„å¯¹è±¡ï¼Œç›´åˆ°å½“å‰å®é™…å®¹é‡å°äºå½“å‰æœ€å¤§å®¹é‡
     * Note2: å¼€å‘è€…å¯ä»¥é€šè¿‡æ­¤æ–¹æ³•åŠ¨æ€åœ°ã€åŒæ­¥åœ°è°ƒæ•´ BitmapPool æœ€å¤§å®¹é‡
     */</span>
    <span class="kt">void</span> <span class="nf">setSizeMultiplier</span><span class="o">(</span><span class="kt">float</span> <span class="n">sizeMultiplier</span><span class="o">);</span>

    <span class="cm">/**
     * åŠ å…¥ä¸€ä¸ªæ–°çš„ä¸ç”¨çš„ bitmap å®ä¾‹åˆ°æ± å­ä¸­, å¦‚æœåŠ å…¥å¤±è´¥è¿”å› false ä¸” , éœ€è¦è°ƒç”¨è€…è‡ªè¡Œæ‰§è¡Œ bitmap.recycle() æ¥é‡Šæ”¾èµ„æº
     *
     * å¯èƒ½è¿”å›å¤±è´¥çš„æƒ…å†µ:
     * 1. bitmap.isMutable() è¿”å›false
     * 2. bitmap åŠ å…¥ä¹‹åå°±è¶…è¿‡äº†æ± å­çš„æœ€å¤§å®¹é‡
     */</span>
    <span class="kt">boolean</span> <span class="nf">put</span><span class="o">(</span><span class="nc">Bitmap</span> <span class="n">bitmap</span><span class="o">);</span>

    <span class="cm">/**
     * æ ¹æ®ä¼ å…¥çš„æ¡ä»¶è¿”å›åˆé€‚çš„ bitmap å®ä¾‹, å¦‚æœæ²¡æœ‰åˆé€‚çš„åˆ™è¿”å›null
     * è¯¥æ–¹æ³•ä¼šé»˜è®¤æ“¦é™¤åŸ bitmap å®ä¾‹ä¸­å­˜å‚¨çš„åƒç´ å€¼, èµ‹å€¼æˆé€æ˜
     * é€Ÿåº¦æ¯” getDirty() è¦æ…¢äº›
     */</span>
    <span class="nc">Bitmap</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">);</span>

    <span class="cm">/**
     * å’Œ get() æ–¹æ³•è¯­ä¹‰ä¸€è‡´, åŒºåˆ«æ˜¯, ä¸ä¼šæ“¦é™¤æ—§çš„åƒç´ æ•°æ®
     * é€Ÿåº¦æ¯” get() è¦å¿«
     */</span>
    <span class="nc">Bitmap</span> <span class="nf">getDirty</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">);</span>

    <span class="cm">/**
     * æ¸…ç©ºæ± å­ä¸­çš„ç¼“å­˜æ•°æ®
     */</span>
    <span class="kt">void</span> <span class="nf">clearMemory</span><span class="o">();</span>

    <span class="cm">/**
     * åšæŒ‡å®šçº§åˆ«çš„ç¼“å­˜æ•°æ®æ¸…ç©º ( æ„æ€æ˜¯æ¸…é™¤å¤šå°‘æ•°æ®ç”± level å†³å®š )
     */</span>
    <span class="kt">void</span> <span class="nf">trimMemory</span><span class="o">(</span><span class="kt">int</span> <span class="n">level</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>çœ‹å®Œä¸Šé¢çš„æ¥å£æŠ½è±¡, å¤§å®¶åº”è¯¥å¯¹ BitmapPool è¦å®ç°çš„åŠŸèƒ½æœ‰æ‰€äº†è§£äº†, ä¸‹é¢æ¥çœ‹çœ‹ BitmapPool çš„å…·ä½“å®ç°</p>
<ol>
  <li><strong>BitmapPoolAdapter</strong>  ç©ºå®ç°</li>
  <li><strong>LruBitmapPool</strong> éµå¾ª LRU(least recently used) ç®—æ³•çš„å®ç°</li>
</ol>

<h2 id="bitmappooladapter-ç©ºå®ç°">BitmapPoolAdapter ç©ºå®ç°</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BitmapPoolAdapter</span> <span class="kd">implements</span> <span class="nc">BitmapPool</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMaxSize</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSizeMultiplier</span><span class="o">(</span><span class="kt">float</span> <span class="n">sizeMultiplier</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Do nothing.</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">put</span><span class="o">(</span><span class="nc">Bitmap</span> <span class="n">bitmap</span><span class="o">)</span> <span class="o">{</span>
    	<span class="c1">// ç©ºå®ç°, è°æ¥éƒ½è¿”å› false</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Bitmap</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Bitmap</span> <span class="nf">getDirty</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearMemory</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Do nothing.</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">trimMemory</span><span class="o">(</span><span class="kt">int</span> <span class="n">level</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Do nothing.</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å¯ä»¥ç›´æ¥çœ‹ put() æ–¹æ³•, è°æ¥éƒ½è¿”å› false , æ± å­é‡Œä¸å¯èƒ½æœ‰æ•°æ®, æ‰€ä»¥å¾ˆå®¹æ˜“å¾—å‡º, æ˜¯ä¸ª<strong>å‡å®ç°</strong></p>
<ul>
  <li><strong>é—®é¢˜: ä¸ºå•¥éœ€è¦è¿™ä¸ªå‡å®ç° ???</strong>
è¿½è¸ª Glide ä¸­ BitmapPool åˆå§‹åŒ–çš„åœ°æ–¹
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1">// GlideBuilder</span>
  <span class="nc">Glide</span> <span class="nf">createGlide</span><span class="o">()</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">bitmapPool</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      	<span class="c1">// Build.VERSION_CODES.HONEYCOMB ( api: 11 , android 3.0)</span>
          <span class="k">if</span> <span class="o">(</span><span class="nc">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">HONEYCOMB</span><span class="o">)</span> <span class="o">{</span>
              <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="na">getBitmapPoolSize</span><span class="o">();</span>
              <span class="n">bitmapPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LruBitmapPool</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          	<span class="c1">// android 3.0 ä»¥ä¸‹éœ€è¦è¿™ä¸ªç©ºå®ç°</span>
              <span class="n">bitmapPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BitmapPoolAdapter</span><span class="o">();</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="o">...</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>å› ä¸ºåœ¨3.0ä»¥å‰ Bitmap çš„æ•°æ®æ˜¯å­˜åœ¨ native åŒºåŸŸï¼Œ3.0ä»¥åå­˜åœ¨ Dalvik å†…å­˜åŒºåŸŸï¼ŒAPI11 å ç³»ç»Ÿæä¾›äº† Bitmap å¤ç”¨çš„ API, <a href="https://developer.android.com/topic/performance/graphics/manage-memory.html">å®˜æ–¹è¯¦ç»†ä¼ é€é—¨</a>
åˆ†æå®Œ BitmapPoolAdapter ç©ºå®ç°å­˜åœ¨çš„æ„ä¹‰, èµ¶ç´§æ¥çœ‹çœ‹æ­£ç»å®ç°é•¿å•¥æ ·</p>
  </li>
</ul>

<h2 id="lrubitmappool-lruç®—æ³•å®ç°">LruBitmapPool LRUç®—æ³•å®ç°</h2>

<h3 id="lrubitmappool-å¤–å£³">LruBitmapPool å¤–å£³</h3>
<p>å…ˆçœ‹æ„é€ å‡½æ•°</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">// LruBitmapPool</span>
	<span class="kd">public</span> <span class="nf">LruBitmapPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">maxSize</span><span class="o">,</span> <span class="n">getDefaultStrategy</span><span class="o">(),</span> <span class="n">getDefaultAllowedConfigs</span><span class="o">());</span>
    <span class="o">}</span>

	<span class="nc">LruBitmapPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxSize</span><span class="o">,</span> <span class="nc">LruPoolStrategy</span> <span class="n">strategy</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">&gt;</span> <span class="n">allowedConfigs</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">initialMaxSize</span> <span class="o">=</span> <span class="n">maxSize</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maxSize</span> <span class="o">=</span> <span class="n">maxSize</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">strategy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">allowedConfigs</span> <span class="o">=</span> <span class="n">allowedConfigs</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tracker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NullBitmapTracker</span><span class="o">();</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>æœ‰å‡ ä¸ªé—®é¢˜éœ€è¦å¼„æ˜ç™½:</p>
  <ol>
    <li>size ä¼ çš„å¤šå°‘, åœ¨å“ªè¾¹è®¡ç®—çš„?
é»˜è®¤4ä¸ªå±å¹•å¤§å°, åœ¨ MemorySizeCalculator ä¸­å¯æŸ¥æ‰¾ç­”æ¡ˆ</li>
    <li>strategy æ˜¯å¹²å˜›çš„?
çœŸæ­£å®ç° LRU ç­–ç•¥çš„åœ°æ–¹</li>
    <li>allowedConfigs åˆæ˜¯å¹²å˜›çš„?
çº¦æŸç¼“å­˜çš„ Bitmap å®ä¾‹çš„ config, è¦æ±‚å¿…é¡»æ˜¯ allowedConfigs ä¸­çš„ä¸€ç§</li>
  </ol>
</blockquote>

<p>æ± å­æœ€ä¸»è¦æ˜¯çœ‹ get() å’Œ put() æ–¹æ³•</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LruBitmapPool</span> <span class="kd">implements</span> <span class="nc">BitmapPool</span> <span class="o">{</span>
	<span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">boolean</span> <span class="nf">put</span><span class="o">(</span><span class="nc">Bitmap</span> <span class="n">bitmap</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bitmap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">"Bitmap must not be null"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">bitmap</span><span class="o">.</span><span class="na">isMutable</span><span class="o">()</span> <span class="o">||</span> <span class="n">strategy</span><span class="o">.</span><span class="na">getSize</span><span class="o">(</span><span class="n">bitmap</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">maxSize</span> <span class="o">||</span> <span class="o">!</span><span class="n">allowedConfigs</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">bitmap</span><span class="o">.</span><span class="na">getConfig</span><span class="o">()))</span> <span class="o">{</span>
            <span class="c1">// bitmap.isMutable() == false;</span>
            <span class="c1">// åŠ å…¥è¿™ä¸ª bitmap å®ä¾‹, ä¼šè¶…å‡ºæ± å­çš„æœ€å¤§å­˜å‚¨å®¹é‡</span>
            <span class="c1">// è¿™ä¸ª bitmap çš„ config ä¸åœ¨æ± å­å…è®¸çš„èŒƒç•´å†…</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="na">getSize</span><span class="o">(</span><span class="n">bitmap</span><span class="o">);</span>
        <span class="c1">// åŠ å…¥çœŸæ­£çš„ LRU ç¼“å­˜ä¸­</span>
        <span class="n">strategy</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">bitmap</span><span class="o">);</span>
        <span class="c1">// ä¿®æ”¹å½“å‰æ± å­çš„å¤§å°</span>
        <span class="n">currentSize</span> <span class="o">+=</span> <span class="n">size</span><span class="o">;</span>
		<span class="c1">// æ£€æŸ¥å½“å‰æ± å­å¤§å°, å¦‚æœå¤§äºæœ€å¤§å®¹é‡, å°±å¾€å¤–ä¸¢ bitmap å®ä¾‹, ç›´åˆ°ä¸è¶…å®¹é‡</span>
        <span class="n">evict</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="nc">Bitmap</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Bitmap</span> <span class="n">result</span> <span class="o">=</span> <span class="n">getDirty</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ“¦é™¤åŸæ¥ bitmap å®ä¾‹çš„åƒç´ æ•°æ®</span>
            <span class="n">result</span><span class="o">.</span><span class="na">eraseColor</span><span class="o">(</span><span class="nc">Color</span><span class="o">.</span><span class="na">TRANSPARENT</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

	<span class="kd">public</span> <span class="kd">synchronized</span> <span class="nc">Bitmap</span> <span class="nf">getDirty</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä» LRU ç¼“å­˜ä¸­æ‹¿å‡ºä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ bitmap å®ä¾‹</span>
        <span class="kd">final</span> <span class="nc">Bitmap</span> <span class="n">result</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">config</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">config</span> <span class="o">:</span> <span class="no">DEFAULT_CONFIG</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ‹¿å‡ºå¤±è´¥, è¿”å› null</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// æ‹¿å‡ºæˆåŠŸ, é‡æ–°è®¡ç®—æ± å­å¤§å°</span>
            <span class="n">currentSize</span> <span class="o">-=</span> <span class="n">strategy</span><span class="o">.</span><span class="na">getSize</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡º:</p>
<ol>
  <li>æ ¸å¿ƒçš„<strong>ç¼“å­˜åŠŸèƒ½</strong>éƒ½æ˜¯ <strong>LruPoolStrategy</strong> åœ¨å®ç°</li>
  <li>LruBitmapPool ä¸»è¦è´Ÿè´£ <strong>å…¥å£çš„æ¡ä»¶åˆ¤æ–­</strong> ( put()æ—¶ ) å’Œ <strong>æ± å­çš„å¤§å°ç®¡ç†</strong></li>
</ol>

<h3 id="lrupoolstrategy-æ ¸å¿ƒ">LruPoolStrategy æ ¸å¿ƒ</h3>
<p>ä¸‹é¢è¿½è¸ª LruPoolStrategy çš„å®ç°</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1">// LruBitmapPool</span>
	<span class="kd">public</span> <span class="nf">LruBitmapPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">maxSize</span><span class="o">,</span> <span class="n">getDefaultStrategy</span><span class="o">(),</span> <span class="n">getDefaultAllowedConfigs</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">LruPoolStrategy</span> <span class="nf">getDefaultStrategy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">LruPoolStrategy</span> <span class="n">strategy</span><span class="o">;</span>
        <span class="c1">// KITKAT ( api: 19 , android 4.4 )</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">KITKAT</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SizeConfigStrategy</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeStrategy</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">strategy</span><span class="o">;</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>é—®é¢˜:
ä¸ºå•¥ KITKAT å‰åä½¿ç”¨ä¸åŒçš„å®ç°æ–¹æ¡ˆ? è¿™åœ°æ–¹æš‚æ—¶è¿˜è¯´æ˜ä¸äº†, ç­‰åˆ°æ–‡ç« å¿«ç»“æŸæ—¶è¿›è¡Œè¯´æ˜</p>
</blockquote>

<p><img src="https://img-blog.csdnimg.cn/20210317210215215.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1Nzc4MzY5,size_10,color_FFFFFF,t_10" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />
è¿™å¼ å›¾å¤§å®¶è¿˜æœ‰å°è±¡å§, æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å…¶ä¸­ä¸€ä¸ª <strong>AttributeStrategy çš„æ•°æ®ç»“æ„</strong>, å…¶ä»–çš„ä½¿ç”¨ç±»æ¨, å°±ä¼šç®€å•å¾ˆå¤šäº†
<img src="https://img-blog.csdnimg.cn/20210320135643832.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1Nzc4MzY5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>

<p>ä¸‹é¢æ¥å¯¹å„ä¸ªå±æ€§è¿›è¡Œè¯´æ˜</p>
<ol>
  <li><strong>Key</strong> æ˜¯<strong>æŸ¥æ‰¾æ¡ä»¶</strong>, ç”¨æ¥å”¯ä¸€è¯†åˆ« <strong>ä¸€ç»„Bitmaps</strong></li>
  <li><strong>KeyPool</strong> æ˜¯ç”¨æ¥<strong>ç¼“å­˜å¹¶å¤ç”¨ Key å®ä¾‹</strong>çš„,  æƒ³æƒ³çœ‹: ä¸Šè¿°æ¡ˆä¾‹, é•¿åˆ—è¡¨æ»‘åŠ¨, é¢‘ç¹çš„ä» BitmapPool é‡Œé¢ get() put() åŠ¿å¿…ä¼šé¢‘ç¹çš„åˆ›å»ºå’Œé‡Šæ”¾ Key å®ä¾‹, è¿™é‡Œç”¨ä¸ª Pool æŠŠ Key å®ä¾‹ä»¬ç¼“å­˜èµ·æ¥, ä¸å¿…é¢‘ç¹åˆ›å»ºäº†( é¢‡æœ‰å¥—å¨ƒå«Œç–‘! )</li>
  <li><strong>GroupedLinkedMap</strong>é‡Œé¢å°å­˜äº†LRUç¼“å­˜ç­–ç•¥â€™</li>
  <li><strong>HashMapç»“æ„</strong>æ˜¯ç”¨æ¥<strong>é™ä½</strong>æŸ¥æ‰¾ç¬¦åˆ Key æ¡ä»¶çš„<strong>ç®—æ³•æ—¶é—´å¤æ‚åº¦çš„</strong>, å¦‚æœåœ¨<strong>LRU å•å‘å¾ªç¯åˆ—è¡¨</strong>é‡Œé¢æ‰§è¡ŒæŸ¥æ‰¾, æ˜¯ O(n) , è€Œåœ¨ HashMap ä¸­æŸ¥æ‰¾æ˜¯ O(1) ~ O(n) ( <a href="">ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦/ç©ºé—´å¤æ‚åº¦è¯¦è§£,æš‚æœªå®ç°,æ ‡è®°ä¸€ä¸‹</a> ), è¿™é‡Œæ˜¯ä¸€ä¸ªå…¸å‹çš„<strong>ä»¥ç©ºé—´æ¢æ—¶é—´</strong>çš„æ¡ˆä¾‹</li>
  <li><strong>LRU å•å‘å¾ªç¯åˆ—è¡¨</strong> æ˜¯çœŸæ­£çš„ <strong>LRU ç¼“å­˜</strong>
    <blockquote>
      <p>æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª LinkedEntry å®ä¾‹;
æ¯ä¸ª LinkedEntry å®ä¾‹åˆå­˜å‚¨äº†<strong>ç¬¦åˆ Key æ¡ä»¶çš„ ä¸€ç»„ Bitmap</strong>;
å½“å¾€ BitmapPool put() çš„æ—¶å€™: 1. æ‰¾åˆ°ç¬¦åˆ Key æ¡ä»¶çš„ Entry, æ’å…¥Entry çš„ values é˜Ÿå°¾; 2. æ‰¾ä¸åˆ°, æ°¸è¿œæ’å…¥é˜Ÿå°¾, ä»£è¡¨ç€æœ€è¿‘ä¸å¸¸ä½¿ç”¨
å½“å¾€ BitmapPool get() çš„æ—¶å€™: 1. æ‰¾åˆ°ç¬¦åˆ Key æ¡ä»¶çš„ Entry, ç§»é™¤ Entry ä¸­ values æœ€åä¸€æ¡ç»™å¤–éƒ¨ä½¿ç”¨; 2.  3. æ‰¾ä¸åˆ°, åˆ›å»ºä¸€ä¸ªæ–°çš„æ¡ä»¶ä¸º Key çš„ Entry; 4.  ç§»åŠ¨ Entry åˆ°é˜Ÿå¤´, ä»£è¡¨æœ€è¿‘æœ€å¸¸ä½¿ç”¨</p>
    </blockquote>
  </li>
</ol>

<p>ç†è®ºè®²å®Œæ¥çœ‹çœ‹å®è·µ ( æºç  )</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="c1">// AttributeStrategy</span>
<span class="kd">class</span> <span class="nc">AttributeStrategy</span> <span class="kd">implements</span> <span class="nc">LruPoolStrategy</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">KeyPool</span> <span class="n">keyPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KeyPool</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">GroupedLinkedMap</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">&gt;</span> <span class="n">groupedMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GroupedLinkedMap</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">&gt;();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="nc">Bitmap</span> <span class="n">bitmap</span><span class="o">)</span> <span class="o">{</span>
    	<span class="c1">// ä» keyPool ç¼“å­˜ä¸­æ‹¿å– Key å®ä¾‹è¿›è¡Œå¤ç”¨</span>
        <span class="kd">final</span> <span class="nc">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keyPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">(),</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getConfig</span><span class="o">());</span>

		<span class="c1">// è°ƒç”¨ GroupedLinkedMap æ¥è¿›è¡Œ LRU ç¼“å­˜</span>
        <span class="n">groupedMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">bitmap</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Bitmap</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
    	<span class="c1">// ä» keyPool ç¼“å­˜ä¸­æ‹¿å– Key å®ä¾‹è¿›è¡Œå¤ç”¨</span>
        <span class="kd">final</span> <span class="nc">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keyPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>

		<span class="c1">// è°ƒç”¨ GroupedLinkedMap æ¥è¿›è¡Œ LRU ç¼“å­˜çš„è·å–</span>
        <span class="k">return</span> <span class="n">groupedMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// AttributeStrategy$KeyPool</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">KeyPool</span> <span class="kd">extends</span> <span class="nc">BaseKeyPool</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nc">Key</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Key</span> <span class="n">result</span> <span class="o">=</span> <span class="n">get</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="nc">Key</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Key</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="c1">// BaseKeyPool</span>
<span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseKeyPool</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">Poolable</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_SIZE</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
    <span class="c1">// å°±æ˜¯ä¸ªç®€å•çš„é˜Ÿåˆ—å®ç°, æœ€å¤§å­˜å‚¨å®¹é‡æ˜¯20</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Queue</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">keyPool</span> <span class="o">=</span> <span class="nc">Util</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">MAX_SIZE</span><span class="o">);</span>

    <span class="kd">protected</span> <span class="no">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
        <span class="no">T</span> <span class="n">result</span> <span class="o">=</span> <span class="n">keyPool</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">create</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">offer</span><span class="o">(</span><span class="no">T</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">keyPool</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="no">MAX_SIZE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">keyPool</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="no">T</span> <span class="nf">create</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ°</p>
<ol>
  <li>KeyPool, å°±æ˜¯ä¸€ä¸ªå®¹é‡ä¸º 20 çš„é˜Ÿåˆ—, å¾ˆç®€å•,</li>
  <li>put() å’Œ get() è¿˜æ˜¯é€šè¿‡ <strong>GroupedLinkedMap</strong>æ¥å®ç°åŠŸèƒ½</li>
</ol>

<p>è¿½è¸ªè¿›å» GroupedLinkedMap</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">GroupedLinkedMap</span><span class="o">&lt;</span><span class="no">K</span> <span class="kd">extends</span> <span class="nc">Poolable</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="c1">// å•å‘å¾ªç¯é“¾è¡¨</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">LinkedEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;();</span>
    <span class="c1">// ç©ºé—´æ¢æ—¶é—´çš„ HashMap</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="nc">LinkedEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">keyToEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="nc">LinkedEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">LinkedEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">keyToEntry</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">key</span><span class="o">);</span>
            <span class="c1">// æ’å…¥æ–°çš„, ç›´æ¥æ’å…¥åˆ°å¾ªç¯é“¾è¡¨é˜Ÿå°¾, ä»£è¡¨æœ€è¿‘ä¸å¸¸ä½¿ç”¨</span>
            <span class="n">makeTail</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
            <span class="n">keyToEntry</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">entry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">key</span><span class="o">.</span><span class="na">offer</span><span class="o">();</span>
        <span class="o">}</span>

		<span class="c1">// æ’å…¥æ—§çš„(åŒ¹é…åˆ°Keyæ¡ä»¶), ç›´æ¥æ’å…¥</span>
        <span class="n">entry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="no">V</span> <span class="nf">get</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">LinkedEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">keyToEntry</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">key</span><span class="o">);</span>
            <span class="c1">// æ‰¾ä¸åˆ°ç¬¦åˆ Key æ¡ä»¶çš„, åˆ›å»ºä¸€ä¸ªç¬¦åˆ Key æ¡ä»¶çš„ Entry</span>
            <span class="n">keyToEntry</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">entry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">key</span><span class="o">.</span><span class="na">offer</span><span class="o">();</span>
        <span class="o">}</span>

		<span class="c1">// ç§»åŠ¨ Entry åˆ°é˜Ÿå¤´, ä»£è¡¨æœ€è¿‘æœ€å¸¸ä½¿ç”¨</span>
        <span class="n">makeHead</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>

		<span class="c1">// ç§»é™¤ Entry çš„ values é‡Œçš„ä¸€ä¸ª Bitmap å¯¹è±¡ä¾›å¤–éƒ¨ä½¿ç”¨</span>
        <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="na">removeLast</span><span class="o">();</span>
    <span class="o">}</span>

	<span class="c1">// å†…å­˜ä¸è¶³çš„æ—¶å€™éœ€è¦æ¸…ç†äº†</span>
	<span class="kd">public</span> <span class="no">V</span> <span class="nf">removeLast</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// ä»é˜Ÿå°¾å¼€å§‹æ¸…é™¤, æ¸…é™¤æœ€è¿‘ä¸å¸¸ä½¿ç”¨</span>
        <span class="nc">LinkedEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">last</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>

        <span class="k">while</span> <span class="o">(!</span><span class="n">last</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">head</span><span class="o">))</span> <span class="o">{</span>
            <span class="no">V</span> <span class="n">removed</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="na">removeLast</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">removed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">removed</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">removeEntry</span><span class="o">(</span><span class="n">last</span><span class="o">);</span>
                <span class="n">keyToEntry</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">last</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
                <span class="n">last</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">offer</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä»¥ä¸Š AttributeStrategy çš„åŸç†è®²å®Œäº†, ä¸‹é¢æ¥çœ‹çœ‹å¦å¤–ä¸€ä¸ªå®ç° SizeConfigStrategy,</p>
<ol>
  <li>å®ƒå’Œ AttributeStrategy çš„åŒºåˆ«åœ¨äºå­˜å‚¨çš„Keyå€¼æ¡ä»¶ä¸ä¸€æ ·, <strong>SizeConfigStrategy çš„ Key æ˜¯ size (w*h) å’Œ config ç»„æˆ</strong>, ä¹‹æ‰€ä»¥èƒ½è¿™ä¹ˆåšå®Œå…¨ä¾èµ–äº Bitmap çš„ä¸€ä¸ªæ–¹æ³• reconfigure()</li>
  <li>è¿˜è®°å¾—å‰æ–‡æåˆ° KITKAT å‰å LruPoolStrategy çš„ä¸åŒå®ç°, <strong>reconfigure()</strong> æ–¹æ³•å°±æ˜¯åœ¨ KITKAT ä¹‹åæ‰æ”¯æŒçš„</li>
  <li><strong>reconfigure()</strong> ä½œç”¨å¾ˆç®€å•å°±æ˜¯ä¿®æ”¹å·²å­˜åœ¨çš„ Bitmap çš„å¤§å°é…ç½®, è¿™æ ·æ‰èƒ½è®©ç¼“å­˜ä»¥æ¯”è¾ƒæ¨¡ç³Šçš„ Size ç»´åº¦è¿›è¡Œ, è€Œä¸æ˜¯ width å’Œ height çš„å¼ºåˆ¶åŒ¹é…</li>
</ol>

<p>ä¸‹é¢æ¥çœ‹çœ‹ <strong>SizeConfigStrategy</strong> ä¸ <strong>AttributeStrategy</strong> ä¸åŒçš„åœ°æ–¹</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="c1">// SizeConfigStrategy</span>

	<span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Bitmap</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="nc">Util</span><span class="o">.</span><span class="na">getBitmapByteSize</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
        <span class="nc">Key</span> <span class="n">targetKey</span> <span class="o">=</span> <span class="n">keyPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">size</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
        <span class="c1">// å…³é”®ä»£ç åœ¨è¿™é‡Œ, æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ size çš„ Bitmap ç¼“å­˜å®ä¾‹</span>
        <span class="nc">Key</span> <span class="n">bestKey</span> <span class="o">=</span> <span class="n">findBestKey</span><span class="o">(</span><span class="n">targetKey</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>

        <span class="nc">Bitmap</span> <span class="n">result</span> <span class="o">=</span> <span class="n">groupedMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bestKey</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Decrement must be called before reconfigure.</span>
            <span class="n">decrementBitmapOfSize</span><span class="o">(</span><span class="nc">Util</span><span class="o">.</span><span class="na">getBitmapByteSize</span><span class="o">(</span><span class="n">result</span><span class="o">),</span> <span class="n">result</span><span class="o">.</span><span class="na">getConfig</span><span class="o">());</span>
            <span class="c1">// å°†ç¼“å­˜çš„ Bitmap å®½é«˜å’Œé…ç½®é‡è¡Œä¿®æ”¹, è¿”å›ç»™ä¸‹å¼ å›¾ç”¨</span>
            <span class="n">result</span><span class="o">.</span><span class="na">reconfigure</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="na">getConfig</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">result</span><span class="o">.</span><span class="na">getConfig</span><span class="o">()</span> <span class="o">:</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">.</span><span class="na">ARGB_8888</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Key</span> <span class="nf">findBestKey</span><span class="o">(</span><span class="nc">Key</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Key</span> <span class="n">result</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">possibleConfig</span> <span class="o">:</span> <span class="n">getInConfigs</span><span class="o">(</span><span class="n">config</span><span class="o">))</span> <span class="o">{</span>
        	<span class="c1">// æ‰¾åˆ°ç¬¦åˆ config çš„ä¸€ç»„ size</span>
            <span class="nc">NavigableMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">sizesForPossibleConfig</span> <span class="o">=</span> <span class="n">getSizesForConfig</span><span class="o">(</span><span class="n">possibleConfig</span><span class="o">);</span>
            <span class="c1">// ä» size é‡Œé¢æ¯”å½“å‰éœ€è¦çš„å¤§çš„æ‰€æœ‰sizeä¸­, æ‰¾åˆ°æœ€å°çš„é‚£ä¸ª è¿”å›ç»™å¤–é¢</span>
            <span class="nc">Integer</span> <span class="n">possibleSize</span> <span class="o">=</span> <span class="n">sizesForPossibleConfig</span><span class="o">.</span><span class="na">ceilingKey</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">possibleSize</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">possibleSize</span> <span class="o">&lt;=</span> <span class="n">size</span> <span class="o">*</span> <span class="no">MAX_SIZE_MULTIPLE</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">possibleSize</span> <span class="o">!=</span> <span class="n">size</span>
                        <span class="o">||</span> <span class="o">(</span><span class="n">possibleConfig</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">config</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">:</span> <span class="o">!</span><span class="n">possibleConfig</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">config</span><span class="o">)))</span> <span class="o">{</span>
                    <span class="n">keyPool</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">keyPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">possibleSize</span><span class="o">,</span> <span class="n">possibleConfig</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

	<span class="kd">private</span> <span class="nc">NavigableMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">getSizesForConfig</span><span class="o">(</span><span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// æ‰¾åˆ°ç¬¦åˆ config çš„ä¸€ç»„ size</span>
        <span class="nc">NavigableMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">sizes</span> <span class="o">=</span> <span class="n">sortedSizes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sizes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;();</span>
            <span class="n">sortedSizes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">sizes</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sizes</span><span class="o">;</span>
    <span class="o">}</span>

	<span class="c1">// ç¼“å­˜, æŒ‰ç…§ config ä¸º Key çš„æ–¹å¼å­˜å‚¨ä¸€ç»„ Bitmap çš„ size</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">,</span> <span class="nc">NavigableMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">sortedSizes</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">Bitmap</span><span class="o">.</span><span class="na">Config</span><span class="o">,</span> <span class="nc">NavigableMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;&gt;();</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ol>
  <li>å…³äº sortedSizes è¿˜æ˜¯ä¸ºäº† <strong>ç©ºé—´æ¢æ—¶é—´</strong> , ä¸»è¦èµšå–ä¸€ä¸ªéå†çš„æ—¶é—´æˆæœ¬å·®ä»·</li>
  <li>get æ–¹æ³•ä¼šå…ˆæ‰¾åˆ° config ç›¸å…³çš„ä¸€ç»„size; ç„¶åæ‰¾å‡ºè¿™ä¸€ç»„ size ä¸­æ¯”å½“å‰éœ€è¦ size å¤§çš„å…¨éƒ¨ size; æœ€å, åœ¨ç­›é€‰ä¹‹åçš„ size ç»„ä¸­, æ‰¾åˆ°ä¸€ä¸ªæœ€å°çš„, è¿”å›ç»™å¤–é¢ä½¿ç”¨ ( æ€»ä¹‹: <strong>æ‰¾ä¸€ä¸ªæ¯”éœ€è¦ size å¤§çš„,å¹¶ä¸”æœ€è´´è¿‘éœ€è¦ size çš„ Bitmap ç¼“å­˜å®ä¾‹</strong> )</li>
</ol>

<h2 id="å›é¡¾">å›é¡¾</h2>
<p>è‡³æ­¤, BitmapPool ç›¸å…³çš„å°±è®²å®Œäº†, ä¸‹é¢å›é¡¾ä¸‹è¿™å¼ å›¾
<img src="https://img-blog.csdnimg.cn/2021032013563065.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1Nzc4MzY5,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>

<p>æ ¸å¿ƒåŸç†éƒ½åœ¨è¿™é‡Œäº†, å°±æ˜¯ä¸€ä¸ª<strong>éµå¾ª LRU ç®—æ³•çš„ å¯¹è±¡æ± å­</strong>, æˆ–è€…å†ç²¾ç¡®äº›, å°±æ˜¯ä¸€ä¸ª<strong>å•å‘å¾ªç¯é“¾è¡¨</strong>, åˆ—è¡¨çš„æ¯ä¸ªå…ƒç´ éƒ½å­˜ç€ä¸€ç»„ Bitmap ç¼“å­˜å®ä¾‹, ä»¥å¤‡å¤–é¢ä½¿ç”¨</p>
:ET